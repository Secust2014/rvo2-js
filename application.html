<html>
<head>
	<script type="text/javascript" src="./common.js"></script>
	<script type="text/javascript" src="./agent.js"></script>
	<script type="text/javascript" src="./kdtree.js"></script>
	<script type="text/javascript" src="./simulator.js"></script>
	<title>Simulator</title>
</head>
<body>
	<script type="text/javascript">
		var setPreferredVelocities = function(simulator)
		{
			// Set the preferred velocity for each agent.
			for (var i = 0; i < simulator.getNumAgents (); ++i) {
				if (RVOMath.absSq (simulator.getGoal(i).minus(simulator.getAgentPosition(i))) < simulator.getAgentRadius (i) * simulator.getAgentRadius (i)) {
					// Agent is within one radius of its goal, set preferred velocity to zero
					simulator.setAgentPrefVelocity (i, new Vector2 (0.0, 0.0));
				} else {
					// Agent is far away from its goal, set preferred velocity as unit vector towards agent's goal.
					simulator.setAgentPrefVelocity (i, RVOMath.normalize (simulator.getGoal(i).minus(simulator.getAgentPosition (i))));
				}
			}
		}

		var updateVisualization = function(simulator)
		{
			console.log ("TIME " + simulator.getGlobalTime());
			
			// Output the position for all the agents.
			for (var i = 0; i < simulator.getNumAgents (); ++i) {
				console.log("AGENT " + i + " " + simulator.getAgentPosition(i).x + "," + simulator.getAgentPosition(i).y);
			}
			
			console.log("\n");
		}

		var setupScenario = function(simulator)
		{
			// Specify global time step of the simulation.
			simulator.setTimeStep (0.25);
			
			// Specify default parameters for agents that are subsequently added.
			var velocity = new Vector2(-3.0, 6.0);
			simulator.setAgentDefaults (15.0, 10, 10.0, 5.0, 0.5, 2.0, velocity);
			
			// Add agents, specifying their start position.
			simulator.addAgent (new Vector2 (-70.0, -20.0));
			simulator.addAgent (new Vector2 (50.0, -70.0));
			simulator.addAgent (new Vector2 (50.0, 30.0));
			simulator.addAgent (new Vector2 (-40.0, 50.0));
			
			// Create goals
			var goals = [];
			for (var i = 0; i < simulator.getNumAgents (); ++i) {
				goals.push(simulator.getAgentPosition(i).scale(-1));
			}
			simulator.addGoals( goals );
			
			// Add (polygonal) obstacle(s), specifying vertices in counterclockwise order.
			var vertices = [];
			vertices.push(new Vector2 (-7.0, -20.0));
			vertices.push(new Vector2 (7.0, -20.0));
			vertices.push(new Vector2 (7.0, 20.0));
			vertices.push(new Vector2 (-7.0, 20.0));
			
			simulator.addObstacle (vertices);
			
			// Process obstacles so that they are accounted for in the simulation.
			simulator.processObstacles ();
		}

		var simulator = Simulator.instance;
		setupScenario (simulator);
		
		/**
		var callback = function() {
			console.log("CALLBACK");
			setPreferredVelocities(simulator);
			updateVisualization(simulator);
			
			if (!simulator.reachedGoal()) {
				simulator.run(callback);
			} else {
				console.log("END");
			}
		}
		
		callback();
		*/
		
		do {
			setPreferredVelocities(simulator);
			updateVisualization(simulator);
			simulator.run();
		} while (!simulator.reachedGoal());
		
		console.log("END");
		/**
		do {
			updateVisualization (simulator);
			setPreferredVelocities (simulator);
			simulator.doStep ();
		} while (!reachedGoal (simulator));
		*/
	</script>
</body>
</html>